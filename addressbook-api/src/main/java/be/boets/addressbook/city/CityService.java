package be.boets.addressbook.city;

import be.boets.addressbook.domain.City;
import be.boets.addressbook.dto.CityDto;
import be.boets.addressbook.mapper.CityMapper;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.*;

@Service
@Transactional
public class CityService {

    private final CityJpaRepository cityJpaRepository;
    private final CityMapper cityMapper;
    private final CityClient cityClient;
    private final StreetClient streetClient;
    private static List<String> zipCodesBE;

    public CityService(CityJpaRepository cityJpaRepository, CityClient cityClient, StreetClient streetClient, CityMapper cityMapper) {
        this.cityJpaRepository = cityJpaRepository;
        this.cityClient = cityClient;
        this.streetClient = streetClient;
        this.cityMapper = cityMapper;
        if (zipCodesBE == null) {
            initBEZipCode();
        }
    }

    public boolean isInitDataLoaded() {
        return !cityJpaRepository.findAll().isEmpty();
    }

    public List<CityDto> getCity(String zipCode) {
        List<City> cities = cityJpaRepository.findByZipCode(zipCode);
        for (City city : cities) {
            if (city.getStreetNames().isEmpty() && city.getCountryCode().equals("BE")) {
                try {
                    // first get all street names for this zipcode in the database
                    Set<String> streetNames = new HashSet<>(streetClient.retrieveStreets(city.getZipCode()));
                    city.setStreetNames(streetNames);
                    cityJpaRepository.save(city);
                } catch (Exception e) {
                    // TODO add logging
                    System.out.println(e.getMessage());
                }
            }
        }
        return cityMapper.toDtos(cities);
    }

    public List<CityDto> getAllCities() {
        List<City> cities = cityJpaRepository.findAll();
        List<CityDto> cityDtos = new ArrayList<>();
        for (City city : cities) {
            CityDto cityDto = cityMapper.toDto(city);
            cityDtos.add(cityDto);
        }
        return cityDtos;
    }

    public boolean loadAllCities() {
        Set<City> cities = new HashSet<>();
        for (String zipCode : zipCodesBE) {
            Optional<Set<City>> loadedCitySet = loadCity(zipCode);
            loadedCitySet.ifPresent(cities::addAll);
        }
        cityJpaRepository.saveAll(cities);
        return isInitDataLoaded();
    }

    protected Optional<Set<City>> loadCity(String zipCode) {
        try {
            return Optional.of(cityClient.retrieveCity(zipCode));
        } catch (Exception e) {
            return Optional.empty();
        }
    }

    private static void initBEZipCode() {
        zipCodesBE = Arrays.asList(
                "0612", "1000", "1005", "1006", "1007", "1008", "1009", "1011", "1012", "1020",
                "1030", "1031", "1033", "1035", "1040", "1041", "1043", "1044", "1046", "1047",
                "1048", "1049", "1050", "1060", "1070", "1080", "1081", "1082", "1083", "1090",
                "1099", "1100", "1101", "1105", "1110", "1120", "1130", "1140", "1150", "1160",
                "1170", "1180", "1190", "1200", "1210", "1212", "1300", "1300", "1301", "1310",
                "1315", "1315", "1315", "1315", "1315", "1320", "1320", "1320", "1320", "1320",
                "1325", "1325", "1325", "1325", "1325", "1330", "1331", "1332", "1340", "1341",
                "1342", "1348", "1350", "1350", "1350", "1350", "1350", "1350", "1350", "1357",
                "1357", "1357", "1360", "1360", "1360", "1360", "1360", "1367", "1367", "1367",
                "1367", "1367", "1367", "1367", "1367", "1370", "1370", "1370", "1370", "1370",
                "1370", "1370", "1370", "1370", "1370", "1380", "1380", "1380", "1380", "1380",
                "1390", "1390", "1390", "1390", "1390", "1400", "1400", "1401", "1402", "1404",
                "1410", "1420", "1421", "1428", "1430", "1430", "1430", "1435", "1435", "1435",
                "1440", "1440", "1450", "1450", "1450", "1450", "1457", "1457", "1457", "1460",
                "1460", "1461", "1470", "1470", "1470", "1471", "1472", "1473", "1474", "1476",
                "1480", "1480", "1480", "1480", "1490", "1495", "1495", "1495", "1495", "1495",
                "1500", "1501", "1502", "1540", "1540", "1541", "1547", "1560", "1570", "1570",
                "1570", "1600", "1600", "1600", "1601", "1602", "1620", "1630", "1640", "1650",
                "1651", "1652", "1653", "1654", "1670", "1670", "1670", "1671", "1673", "1674",
                "1700", "1700", "1700", "1701", "1702", "1703", "1730", "1730", "1730", "1730",
                "1731", "1731", "1733", "1740", "1741", "1742", "1745", "1745", "1750", "1750",
                "1750", "1755", "1755", "1755", "1755", "1760", "1760", "1760", "1760", "1761",
                "1770", "1780", "1785", "1785", "1785", "1790", "1790", "1790", "1790", "1800",
                "1800", "1804", "1818", "1820", "1820", "1820", "1830", "1831", "1840", "1840",
                "1840", "1850", "1851", "1852", "1853", "1860", "1861", "1880", "1880", "1880",
                "1910", "1910", "1910", "1910", "1930", "1930", "1931", "1932", "1933", "1934",
                "1935", "1950", "1970", "1980", "1980", "1981", "1982", "1982", "2000", "2018",
                "2020", "2030", "2040", "2040", "2040", "2040", "2050", "2060", "2070", "2070",
                "2099", "2100", "2110", "2140", "2150", "2160", "2170", "2180", "2200", "2200",
                "2200", "2220", "2220", "2221", "2222", "2222", "2223", "2230", "2230", "2235",
                "2235", "2235", "2240", "2240", "2240", "2242", "2243", "2250", "2260", "2260",
                "2260", "2260", "2270", "2275", "2275", "2275", "2275", "2280", "2288", "2290",
                "2300", "2310", "2320", "2321", "2322", "2323", "2328", "2330", "2340", "2340",
                "2350", "2360", "2370", "2380", "2381", "2382", "2387", "2390", "2390", "2390",
                "2400", "2430", "2430", "2431", "2431", "2440", "2450", "2460", "2460", "2460",
                "2470", "2480", "2490", "2491", "2500", "2500", "2520", "2520", "2520", "2520",
                "2530", "2531", "2540", "2547", "2550", "2550", "2560", "2560", "2560", "2570",
                "2580", "2580", "2590", "2590", "2600", "2610", "2620", "2627", "2630", "2640",
                "2650", "2660", "2800", "2800", "2801", "2811", "2811", "2812", "2820", "2820",
                "2830", "2830", "2830", "2830", "2840", "2840", "2840", "2845", "2850", "2860",
                "2861", "2870", "2870", "2870", "2870", "2880", "2880", "2880", "2880", "2890",
                "2890", "2890", "2900", "2910", "2920", "2930", "2940", "2940", "2950", "2960",
                "2960", "2960", "2970", "2970", "2980", "2980", "2990", "2990", "3000", "3001",
                "3010", "3012", "3018", "3020", "3020", "3020", "3040", "3040", "3040", "3040",
                "3040", "3050", "3051", "3052", "3053", "3054", "3060", "3060", "3061", "3070",
                "3071", "3078", "3078", "3080", "3080", "3080", "3090", "3110", "3111", "3118",
                "3120", "3128", "3130", "3130", "3140", "3150", "3150", "3150", "3190", "3191",
                "3200", "3200", "3201", "3202", "3210", "3211", "3212", "3213", "3220", "3221",
                "3223", "3224", "3230", "3230", "3250", "3251", "3252", "3260", "3270", "3271",
                "3280", "3290", "3290", "3290", "3293", "3300", "3300", "3310", "3320", "3320",
                "3330", "3331", "3331", "3331", "3340", "3350", "3360", "3370", "3370", "3371",
                "3380", "3390", "3391", "3391", "3400", "3410", "3411", "3430", "3440", "3440",
                "3440", "3441", "3441", "3450", "3451", "3454", "3460", "3470", "3470", "3480",
                "3500", "3500", "3510", "3510", "3510", "3520", "3520", "3530", "3530", "3540",
                "3540", "3550", "3551", "3552", "3552", "3553", "3553", "3560", "3560", "3560",
                "3570", "3570", "3580", "3580", "3580", "3590", "3590", "3600", "3600", "3600",
                "3600", "3620", "3630", "3640", "3640", "3650", "3660", "3665", "3670", "3680",
                "3690", "3700", "3710", "3720", "3730", "3730", "3740", "3750", "3760", "3770",
                "3780", "3790", "3800", "3810", "3812", "3813", "3814", "3820", "3830", "3830",
                "3840", "3850", "3860", "3870", "3870", "3880", "3890", "3891", "3892", "3893",
                "3894", "3900", "3910", "3920", "3920", "3930", "3940", "3945", "3950", "3960",
                "3970", "3980", "3990", "3990", "4000", "4010", "4020", "4030", "4040", "4050",
                "4060", "4070", "4080", "4090", "4100", "4110", "4120", "4130", "4140", "4150",
                "4160", "4170", "4180", "4190", "4200", "4210", "4220", "4230", "4240", "4250",
                "4260", "4270", "4280", "4290", "4300", "4310", "4320", "4330", "4340", "4350",
                "4360", "4370", "4380", "4390", "4400", "4410", "4420", "4430", "4440", "4450",
                "4460", "4470", "4480", "4490", "4500", "4510", "4520", "4530", "4540", "4550",
                "4560", "4570", "4580", "4590", "4600", "4610", "4620", "4630", "4640", "4650",
                "4660", "4670", "4680", "4690", "4700", "4710", "4720", "4730", "4740", "4750",
                "4760", "4770", "4780", "4790", "4800", "4810", "4820", "4830", "4840", "4850",
                "4860", "4870", "4880", "4890", "4900", "4910", "4920", "4930", "4940", "4950",
                "4960", "4970", "4980", "4990", "5000", "5010", "5020", "5030", "5040", "5050",
                "5060", "5070", "5080", "5090", "5100", "5110", "5120", "5130", "5140", "5150",
                "5160", "5170", "5180", "5190", "5200", "5210", "5220", "5230", "5240", "5250",
                "5260", "5270", "5280", "5290", "5300", "5310", "5320", "5330", "5340", "5350",
                "5360", "5370", "5380", "5390", "5400", "5410", "5420", "5430", "5440", "5450",
                "5460", "5470", "5480", "5490", "5500", "5510", "5520", "5530", "5540", "5550",
                "5560", "5570", "5580", "5590", "5600", "5610", "5620", "5630", "5640", "5650",
                "5660", "5670", "5680", "5690", "5700", "5710", "5720", "5730", "5740", "5750",
                "5760", "5770", "5780", "5790", "5800", "5810", "5820", "5830", "5840", "5850",
                "5860", "5870", "5880", "5890", "5900", "5910", "5920", "5930", "5940", "5950",
                "5960", "5970", "5980", "5990", "6000", "6010", "6020", "6030", "6040", "6050",
                "6060", "6070", "6080", "6090", "6100", "6110", "6120", "6130", "6140", "6150",
                "6160", "6170", "6180", "6190", "6200", "6210", "6220", "6230", "6240", "6250",
                "6260", "6270", "6280", "6290", "6300", "6310", "6320", "6330", "6340", "6350",
                "6360", "6370", "6380", "6390", "6400", "6410", "6420", "6430", "6440", "6450",
                "6460", "6470", "6480", "6490", "6500", "6510", "6520", "6530", "6540", "6550",
                "6560", "6570", "6580", "6590", "6600", "6610", "6620", "6630", "6640", "6650",
                "6660", "6670", "6680", "6690", "6700", "6710", "6720", "6730", "6740", "6750",
                "6760", "6770", "6780", "6790", "6800", "6810", "6820", "6830", "6840", "6850",
                "6860", "6870", "6880", "6890", "6900", "6910", "6920", "6930", "6940", "6950",
                "6960", "6970", "6980", "6990", "7000", "7010", "7020", "7030", "7040", "7050",
                "7060", "7070", "7080", "7090", "7100", "7110", "7120", "7130", "7140", "7150",
                "7160", "7170", "7180", "7190", "7200", "7210", "7220", "7230", "7240", "7250",
                "7260", "7270", "7280", "7290", "7300", "7310", "7320", "7330", "7340", "7350",
                "7360", "7370", "7380", "7390", "7400", "7410", "7420", "7430", "7440", "7450",
                "7460", "7470", "7480", "7490", "7500", "7510", "7520", "7530", "7540", "7550",
                "7560", "7570", "7580", "7590", "7600", "7610", "7620", "7630", "7640", "7650",
                "7660", "7670", "7680", "7690", "7700", "7710", "7720", "7730", "7740", "7750",
                "7760", "7770", "7780", "7790", "7800", "7810", "7820", "7830", "7840", "7850",
                "7860", "7870", "7880", "7890", "7900", "7910", "7920", "7930", "7940", "7950",
                "7960", "7970", "7980", "7990", "8000", "8010", "8020", "8030", "8040", "8050",
                "8060", "8070", "8080", "8090", "8100", "8110", "8120", "8130", "8140", "8150",
                "8160", "8170", "8180", "8190", "8200", "8210", "8220", "8230", "8240", "8250",
                "8260", "8270", "8280", "8290", "8300", "8310", "8320", "8330", "8340", "8350",
                "8360", "8370", "8380", "8390", "8400", "8410", "8420", "8430", "8440", "8450",
                "8460", "8470", "8480", "8490", "8500", "8510", "8520", "8530", "8540", "8550",
                "8560", "8570", "8580", "8590", "8600", "8610", "8620", "8630", "8640", "8650",
                "8660", "8670", "8680", "8690", "8700", "8710", "8720", "8730", "8740", "8750",
                "8760", "8770", "8780", "8790", "8800", "8810", "8820", "8830", "8840", "8850",
                "8860", "8870", "8880", "8890", "8900", "8910", "8920", "8930", "8940", "8950",
                "8960", "8970", "8980", "8990", "9000", "9010", "9020", "9030", "9040", "9050",
                "9060", "9070", "9080", "9090", "9100", "9110", "9120", "9130", "9140", "9150",
                "9160", "9170", "9180", "9190", "9200", "9210", "9220", "9230", "9240", "9250",
                "9260", "9270", "9280", "9290", "9300", "9310", "9320", "9330", "9340", "9350",
                "9360", "9370", "9380", "9390", "9400", "9410", "9420", "9430", "9440", "9450",
                "9460", "9470", "9480", "9490", "9500", "9510", "9520", "9530", "9540", "9550",
                "9560", "9570", "9580", "9590", "9600", "9610", "9620", "9630", "9640", "9650",
                "9660", "9670", "9680", "9690", "9700", "9710", "9720", "9730", "9740", "9750",
                "9760", "9770", "9780", "9790", "9800", "9810", "9820", "9830", "9840", "9850",
                "9860", "9870", "9880", "9890", "9900", "9910", "9920", "9930", "9940", "9950",
                "9960", "9970", "9980", "9990", "10000");
    }


}
